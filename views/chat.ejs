<%- include('main/header'); %>
        <!-- Wrapper -->
    <div id="wrapper">

       <!-- contents -->
       <div class="main_content">

            <%- include('main/header_bar'); %>

            <div class="main_content_inner">

                <div id="spinneroverlay"> </div>


                <div class="uk-grid-large" uk-grid>
                    <div class="uk-width-1-3@m ">

                        <div id="sidebar-chat" class="sidebar-chat px-3 mt-4">
                            <div class="uk-offcanvas-bar1" style="max-height: 90vh;">
                
                                <div class="sidebar-chat-head mb-2">
                
                                    <div class="btn-actions">
                                        <a href="#" uk-tooltip="title: Search ;offset:7"
                                            uk-toggle="target: .sidebar-chat-search; animation: uk-animation-slide-top-small"> <i
                                                class="icon-feather-search"></i> </a>
                                        <a href="#" uk-tooltip="title: settings ;offset:7"> <i class="icon-feather-settings"></i> </a>
                                        <a href="#"> <i class="uil-ellipsis-v"></i> </a>
                                        <a href="#" class="uk-hidden@s"> <button class="uk-offcanvas-close uk-close" type="button"
                                                uk-close> </button> </a>
                                    </div>
                
                                    <h2> Chats </h2>
                                </div>
                
                                <div class="sidebar-chat-search" hidden>
                                    <input type="text" class="uk-input" placeholder="Search in Messages">
                                    <span class="btn-close"
                                        uk-toggle="target: .sidebar-chat-search; animation: uk-animation-slide-top-small"> <i
                                            class="icon-feather-x"></i> </span>
                                </div>
                
                                <ul class="uk-child-width-expand sidebar-chat-tabs" uk-tab>
                                    <li class="uk-active"><a href="#">Users</a></li>
                                    <li><a href="#">Groups</a></li>
                                </ul>
                                <%if(userinfos && friends.length>0){%>
                                    <%friends.forEach(function(key){%>
                                        <a href="#" onclick="getMessages('<%=user._id%>','<%=key._id%>')">
                                            <div class="contact-list">
                                                <div class="contact-list-media"> <img src="/Uploads/Avatar/<%=key.avatar%>" alt="">
                                                    <span class="online-dot"></span> </div>
                                                <h5> <%=key.name%></h5>
                                            </div>
                                        </a>
                                <%})%>
                                <%}else{%>
                                    <a href="/explore">
                                        <div class="contact-list">
                                            <h5> Click to Find Friends</h5>
                                        </div>
                                    </a>
                                <%}%>
                            </div>
                        </div>
                    </div>

                    <div class="uk-width-2-3@m "  id="messages" >
                        <!-- <div class="uk-width-expand"> -->
                            <div class="post"  >
                                <!-- <div class="post-heading">
                                    <div class="post-title">
                                        <h4> Click to start a Conversation</h4>
                                    </div>
                                </div> -->
    
                                <!-- post comments -->
                                <div class="post-comments" style="min-height: 70vh;">
                                    <div class="post-title" style="margin-top: 30%; margin-left: 23%;">
                                        <h4> Click on a Friend start a Conversation</h4>
                                    </div>
                                    <!-- <div class="post-comments-single">
                                        <div class="post-comment-avatar">
                                            <img src="assets/images/avatars/avatar-5.jpg" alt="">
                                        </div>
                                        <div class="post-comment-text">
                                            <div class="post-comment-text-inner">
                                                <h6> Alex Dolgove</h6>
                                                <p> Ut wisi enim ad minim laoreet dolore magna aliquam erat </p>
                                            </div>
                                            <div class="uk-text-small">
                                                <a href="#" class="text-danger mr-1"> <i class="uil-heart"></i> Love </a>
                                                <a href="#" class=" mr-1"> Replay </a>
                                                <span> 1d</span>
                                            </div>
                                        </div>
                                        <a href="#" class="post-comment-opt"></a>
                                    </div>
                                    <div class="post-comments-single">
                                        <div class="post-comment-avatar">
                                            <img src="assets/images/avatars/avatar-2.jpg" alt="">
                                        </div>
                                        <div class="post-comment-text">
                                            <div class="post-comment-text-inner">
                                                <h6>Stella Johnson</h6>
                                                <p> Ut wisi enim ad minim laoreet dolore <strong> David !</strong> </p>
                                            </div>
                                            <div class="uk-text-small">
                                                <a href="#" class="text-primary mr-1"> <i class="uil-thumbs-up"></i> Like
                                                </a>
                                                <a href="#" class=" mr-1"> Replay </a>
                                                <span> 2d</span>
                                            </div>
                                        </div>
                                        <a href="#" class="post-comment-opt"></a>
                                    </div>
                                    <div class="post-comments-single">
                                        <div class="post-comment-avatar">
                                            <img src="assets/images/avatars/avatar-3.jpg" alt="">
                                        </div>
                                        <div class="post-comment-text">
                                            <div class="post-comment-text-inner">
                                                <h6> Jonathan Madano </h6>
                                                <p> sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam
                                                    erat
                                                    volutpat.<strong> David !</strong> </p>
                                            </div>
                                            <div class="uk-text-small">
                                                <a href="#" class="text-danger mr-1"> <i class="uil-heart"></i> Love </a>
                                                <a href="#" class=" mr-1"> Replay </a>
                                                <span> 3d</span>
                                            </div>
                                        </div>
                                        <a href="#" class="post-comment-opt"></a>
                                    </div> -->
    
                                    <!-- <div class="post-add-comment">
                                        <div class="post-add-comment-avature">
                                            <img src="assets/images/avatars/avatar-2.jpg" alt="">
                                        </div>
                                        <div class="post-add-comment-text-area">
                                            <input type="text" placeholder="Write your comment...">
                                            <div class="icons">
                                                <span class="uil-link-alt"></span>
                                                <span class="uil-grin"></span>
                                                <span class="uil-image"></span>
                                            </div>
                                        </div>
    
                                    </div> -->
    
                                </div>
    
                            </div>
                         
                        <!-- </div> -->
                    </div>
                    
                </div>



            </div>

        </div>
        

    </div>
    <script src="https://cdn.socket.io/3.1.3/socket.io.min.js" integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh" crossorigin="anonymous"></script>
    <script>
            var socket = io.connect('http://127.0.0.1:3032', {
                            withCredentials: true,
                            extraHeaders: {
                                "my-custom-header": "abcd"
                            }
                     })
            socket.on('newChatMessage',function(msg){
                console.log("emitting",msg)
                getMessages(msg.from,msg.to)
            })
            function addMessage(){
                var messages = document.getElementById('messageinput').value;
                var toid = document.getElementById('toid').value
                let userid = '<%=user._id%>'
                let body = {
                    text:messages,
                    from:userid,
                    to:toid
                }
                console.log("emiter body",body)
                // Respond with a message including this clients' id sent from the server
                socket.emit('newChatMessage', body);
                
                
                // socket.on('time', function(data) {
                //     addMessage(data.time);
                // });
                socket.on('error', console.error.bind(console));
                socket.on('message', console.log.bind(console));

            }
                
            // function addMessage() {

                
            //     console.log(body)
            //     $.ajax({
            //         url:'/message/add',
            //         method:"POST",
            //         data:body,
            //         success:(resp)=>{
            //             getMessages(userid,toid)
            //         }
            //     })
            // }

            function getMessages(userid,toid){
                let uid = userid+'-'+toid

                $.ajax({
                    url:'/message/'+uid,
                    method:"GET",
                    success:(resp)=>{
                        var divhtml="";
                        console.log("message",resp)
                        if(resp.status== true){
                            
                            if(resp.message.length>0){
                                divhtml = `<div class="post" >
                                <div class="post-heading">
                                    <div class="post-avature">
                                        <img src="/Uploads/Avatar/${resp.message[0].to.avatar}" alt="">
                                    </div>
                                    <div class="post-title">
                                        <h4>${resp.message[0].to.name}</h4>
                                    </div>
                                </div>
                                <!-- post comments -->
                                <div class="post-comments" style="min-height: 60vh;overflow-y:scroll">`
                                resp.message.filter((key)=>key.message!=="").map((key,val)=>{
                                    
                                    if(key.to._id == userid){
                                    divhtml += `
        
                                        <div class="post-comments-single">
                                            <div class="post-comment-text">
                                                <div class="post-comment-text-inner">
                                                    <h6>${key.from.name}</h6>
                                                    <p> ${key.message}</p>
                                                </div>
                                            </div>
                                        </div>
                                        `
                                    }
                                    else{
                                        divhtml += `
        
                                        <div class="post-comments-single" style="float:right;">
                                            <div class="post-comment-text">
                                                <div class="post-comment-text-inner">
                                                    <h6>${key.from.name}</h6>
                                                    <p>${key.message}</p>
                                                </div>
                                            </div>
                                        </div>
                                        `
                                    }
                                })
                            divhtml +=`
                                <div class="post-add-comment">
                                        <div class="post-add-comment-text-area" style="margin-top:60%">
                                            <input type="text" placeholder="Send Message" id="messageinput">
                                            <input type="hidden" id ="toid" value="${toid}"/>
                                            <div class="icons">
                                                <span class="uil-link-alt"></span>
                                                <span class="uil-image"></span>
                                                <a href="#" id="buttonadd"onclick="addMessage()">Enter</a>
                                            </div>
                                        </div>
    
                                    </div>
                                </div>
                            </div>`
                        }
                        else{
                            divhtml =`<div class="post" >
                                <!-- <div class="post-heading">
                                    <div class="post-title">
                                        <h4> Click to start a Conversation</h4>
                                    </div>
                                </div> -->
    
                                <!-- post comments -->
                                <div class="post-comments" style="height: 50vh;">
                                    <div class="post-title" style="margin-top: 30%; margin-left: 23%;">
                                        <h4> Click on a Friend start a Conversation</h4>
                                    </div>
                                   
                                </div>
    
                            </div>`
                        }
                        }

                        $('#messages').html(divhtml)
                    }
                })
            }
        </script>

     
    <%- include('main/footer'); %>